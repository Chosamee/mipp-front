options:
  default_logs_bucket_behavior: REGIONAL_USER_OWNED_BUCKET
  # logsBucket: "gs://${_LOGS_BUCKET}"
  logging: "CLOUD_LOGGING_ONLY" # 또는 'NONE'

steps:
  - name: "gcr.io/cloud-builders/npm"
    args: ["run", "build"]
    env:
      - "REACT_APP_API_KEY=${_REACT_APP_API_KEY}"

  # Docker Build
  - name: "gcr.io/cloud-builders/docker"
    args:
      ["build", "-t", "asia-northeast3-docker.pkg.dev/${PROJECT_ID}/my-docker-repo/myimage", "."]

  # Docker Push
  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "asia-northeast3-docker.pkg.dev/${PROJECT_ID}/my-docker-repo/myimage"]

  # Entrypoint, timeout and environment variables
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    timeout: 240s
    args:
      [
        "compute",
        "instances",
        "create-with-container",
        "my-vm-name",
        "--container-image",
        "asia-northeast3-docker.pkg.dev/${PROJECT_ID}/my-docker-repo/myimage",
        "--container-env",
        "REACT_APP_API_KEY=${_REACT_APP_MIPP_API_URL}",
        "REACT_APP_GOOGLE_CLIENT_ID=${_REACT_APP_GOOGLE_CLIENT_ID}",
      ]
    env:
      - "CLOUDSDK_COMPUTE_REGION=asia-northeast3"
      - "CLOUDSDK_COMPUTE_ZONE=asia-northeast3-c"

availableSecrets:
  secretManager:
    - versionName: projects/486098542239/secrets/REACT_APP_MIPP_API_URL/versions/latest
      env: "_REACT_APP_MIPP_API_URL"
    - versionName: projects/486098542239/secrets/REACT_APP_GOOGLE_CLIENT_ID/versions/latest
      env: "_REACT_APP_GOOGLE_CLIENT_ID"
